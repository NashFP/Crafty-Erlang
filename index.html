<!DOCTYPE html>
<html>
<head>
   <meta http-equiv="content-type" content="text/html;charset=utf-8"> 
   <title>Crafty Erlang</title>

<meta name="generator" content="- generator not found -">
<meta name="author"    content="Colin MacDonald" >

<!-- SyntaxHighlighter (sh) style sheet; goes first so we can override styles if needed -->
<!-- todo: add theme-ing support -->
<link rel="stylesheet" href="highlighter/shCoreDefault.css">

<!-- S6 style sheet links -->
<link rel="stylesheet" href="crafty_erlang.css"  media="projection" id="styleProjection">
<link rel="stylesheet" href="s6/screen.css"          media="screen" id="styleScreen">
<link rel="stylesheet" href="s6/print.css"           media="print">

<!-- S6 JS -->
<script src="s6/jquery.js"></script>
<script src="s6/jquery.slideshow.js"></script>

<!-- SyntaxHighlighter (sh) machinery -->
<script src="highlighter/shCore.js"></script>

<!-- SyntaxHighlighter brushes, remove those for languages you don't need --> 
<script src="highlighter/shBrushAppleScript.js"></script>
<script src="highlighter/shBrushAS3.js"></script>
<script src="highlighter/shBrushBash.js"></script>
<script src="highlighter/shBrushColdFusion.js"></script>
<script src="highlighter/shBrushCpp.js"></script>
<script src="highlighter/shBrushCSharp.js"></script>
<script src="highlighter/shBrushCss.js"></script>
<script src="highlighter/shBrushDelphi.js"></script>
<script src="highlighter/shBrushDiff.js"></script>
<script src="highlighter/shBrushErlang.js"></script>
<script src="highlighter/shBrushGroovy.js"></script>
<script src="highlighter/shBrushJavaFX.js"></script>
<script src="highlighter/shBrushJava.js"></script>
<script src="highlighter/shBrushJScript.js"></script>
<script src="highlighter/shBrushPerl.js"></script>
<script src="highlighter/shBrushPhp.js"></script>
<script src="highlighter/shBrushPlain.js"></script>
<script src="highlighter/shBrushPowerShell.js"></script>
<script src="highlighter/shBrushPython.js"></script>
<script src="highlighter/shBrushRuby.js"></script>
<script src="highlighter/shBrushSass.js"></script>
<script src="highlighter/shBrushScala.js"></script>
<script src="highlighter/shBrushSql.js"></script>
<script src="highlighter/shBrushVb.js"></script>
<script src="highlighter/shBrushXml.js"></script>


<script type="text/javascript">

$(document).ready( function() {
  Slideshow.init();
  SyntaxHighlighter.all();
} );

  
 
</script>

<!-- Better Browser Banner for Microsoft Internet Explorer (IE) -->
<!--[if IE]>
<script src="s6/jquery.microsoft.js"></script>
<![endif]-->



</head>
<body>

<div class="layout"> 
  <div id="header"></div>
  <div id="footer">
    <h1></h1>
    <h2></h2>
  </div>
</div><!-- layout -->

<div class="presentation">
   
<div class='slide '>
<h1>Crafty Erlang</h1><h3>An elegant language for small projects</h3>
<p class="author">Colin MacDonald</p>

</div>
<div class='slide '>
<h1>Where we&#8217;re going</h1><ul>
	<li>Small but useful projects</li>
	<li>Thinking in Erlang</li>
	<li>Idioms/design patterns</li>
</ul>

</div>
<div class='slide '>
<h1>&#8220;Synergistic Weirdness&#8221;</h1></div>
<div class='slide '>
<h1>Weirdness &#8211; missing stuff</h1><ul>
	<li>Mutable variables</li>
	<li>Loop controls (for, while)</li>
	<li>Objects</li>
</ul>

</div>
<div class='slide '>
<h1>Weirdness &#8211; extra stuff</h1><ul>
	<li>Pattern matching (and guard expressions)</li>
	<li>Recursion</li>
	<li>Inter-Process Communication/Messaging (IPC)</li>
</ul>

</div>
<div class='slide '>
<h1>Synergistic Weirdness</h1><ul>
	<li>Pattern matching + immutability = clean &amp; easy recursion</li>
	<li>Pattern matching &#8594; clean &amp; easy IPC message handling</li>
	<li>Recursion + IPC = safe mutable resources</li>
</ul>

</div>
<div class='slide '>
<h1>Synergistic Weirdness</h1><p>Not rocket science, just different idioms</p>

</div>
<div class='slide '>
<h1>Recursion is Cheap, Clean, &amp; Easy</h1><ul>
	<li>Use it for <em>everything</em></li>
	<li>All data are function params</li>
	<li>Replaces iteration</li>
	<li>Pattern matching functions replace conditionals</li>
	<li>Standard idioms</li>
</ul>

</div>
<div class='slide '>
<h1>Recursion</h1><ul>
	<li>beginning</li>
	<li>end</li>
	<li>middle</li>
</ul>

</div>
<div class='slide '>
<h1>Recursion</h1><p>Simple case: list munging</p>
<ul>
	<li>beginning</li>
</ul>
<!-- begin code{:lang=>"erlang", :line_numbers=>"false"} -->
<div class='code'><pre class='brush: erlang toolbar: false gutter: false'>
func(Input) -&gt;
    Output = [],
    func(Input, Output).
</pre></div>
<!-- end code -->


</div>
<div class='slide '>
<h1>Recursion</h1><p>Simple case: list munging</p>
<ul>
	<li>beginning</li>
</ul>
<!-- begin code{:lang=>"erlang", :line_numbers=>"false"} -->
<div class='code'><pre class='brush: erlang toolbar: false gutter: false'>
func(Input) -&gt;
    Output = [],
    func(Input, Output).
</pre></div>
<!-- end code -->

<ul>
	<li>end</li>
</ul>
<!-- begin code{:lang=>"erlang", :line_numbers=>"false"} -->
<div class='code'><pre class='brush: erlang toolbar: false gutter: false'>
func([], Output) -&gt; lists:reverse(Output).
</pre></div>
<!-- end code -->


</div>
<div class='slide '>
<h1>Recursion</h1><p>Simple case: list munging</p>
<ul>
	<li>beginning</li>
</ul>
<!-- begin code{:lang=>"erlang", :line_numbers=>"false"} -->
<div class='code'><pre class='brush: erlang toolbar: false gutter: false'>
func(Input) -&gt;
    Output = [],
    func(Input, Output).
</pre></div>
<!-- end code -->

<ul>
	<li>end</li>
</ul>
<!-- begin code{:lang=>"erlang", :line_numbers=>"false"} -->
<div class='code'><pre class='brush: erlang toolbar: false gutter: false'>
func([], Output) -&gt; lists:reverse(Output).
</pre></div>
<!-- end code -->

<ul>
	<li>middle</li>
</ul>
<!-- begin code{:lang=>"erlang", :line_numbers=>"false"} -->
<div class='code'><pre class='brush: erlang toolbar: false gutter: false'>
func([First | Rest], Output) -&gt;
    NewFirst = munge(First),
    func(Rest, [NewFirst | Output]);
</pre></div>
<!-- end code -->


</div>
<div class='slide '>
<h1>Digression: Backwards Lists</h1><ul>
	<li class="none"><strong>Q:</strong> What&#8217;s up with that?</li>
	<li class="none"><strong>A:</strong> Both immutable and efficiently extensible
	<ul>
		<li class="none">Hint: <em>singly</em> linked lists</li>
	</ul></li>
</ul>

</div>
<div class='slide '>
<h1>Digression: Backwards Lists</h1><!-- begin code{:lang=>"erlang", :line_numbers=>"false"} -->
<div class='code'><pre class='brush: erlang toolbar: false gutter: false'>
Foo = [cat, dog].
</pre></div>
<!-- end code -->

<!-- begin step {} -->
<div class='step' markdown='block'>

<pre>Foo
|
cat - dog</pre>
</div>
<!-- end step -->


</div>
<div class='slide '>
<h1>Digression: Backwards Lists</h1><!-- begin code{:lang=>"erlang", :line_numbers=>"false"} -->
<div class='code'><pre class='brush: erlang toolbar: false gutter: false'>
Foo = [cat, dog].
Bar = [monkey|Foo].
</pre></div>
<!-- end code -->

<!-- begin step {} -->
<div class='step' markdown='block'>

<pre>Bar      Foo
|        |
monkey - cat - dog</pre>
</div>
<!-- end step -->


</div>
<div class='slide '>
<h1>Digression: Backwards Lists</h1><!-- begin code{:lang=>"erlang", :line_numbers=>"false"} -->
<div class='code'><pre class='brush: erlang toolbar: false gutter: false'>
Foo = [cat, dog].
Bar = [monkey|Foo].
Baz = [elephant|Bar].
</pre></div>
<!-- end code -->

<!-- begin step {} -->
<div class='step' markdown='block'>

<pre>Baz        Bar      Foo
|          |        |
elephant - monkey - cat - dog</pre>
</div>
<!-- end step -->


</div>
<div class='slide '>
<h1>Back to recursion: Bowling Game</h1><ul>
	<li>Calculate score for a bowling game.</li>
	<li>Input is a list of rolls</li>
	<li>Output is a number &#8211; the final score</li>
	<li>Need to keep track of frame numbers &#8211; not fixed number of rolls</li>
	<li>Frame score may depend on other frames
	<ul>
		<li><em>OO metaphor shear</em></li>
	</ul></li>
</ul>

</div>
<div class='slide '>
<h1>Bowling Game</h1><!-- begin code{:lang=>"erlang", :line_numbers=>"false"} -->
<div class='code'><pre class='brush: erlang toolbar: false gutter: false'>

 %% Beginning: score/1 -&gt; score/3
score(Rolls) -&gt;
    Frame = 1,
    Score = 0,
    score(Rolls, Frame, Score).
</pre></div>
<!-- end code -->


</div>
<div class='slide '>
<h1>Bowling Game</h1><!-- begin code{:lang=>"erlang", :line_numbers=>"false"} -->
<div class='code'><pre class='brush: erlang toolbar: false gutter: false'>
 %% Beginning
score(Rolls) -&gt;
    score(Rolls, 1, 0).

 %% End
score(_Rolls, 11, Score) -&gt; Score.
</pre></div>
<!-- end code -->


</div>
<div class='slide '>
<h1>Bowling Game</h1><!-- begin code{:lang=>"erlang", :line_numbers=>"false"} -->
<div class='code'><pre class='brush: erlang toolbar: false gutter: false'>
 %% Beginning
score(Rolls) -&gt;
    score(Rolls, 1, 0).

 %% End
score(_Rolls, 11, Score) -&gt; Score;

 %% Middle
score([Roll1, Roll2 | Rest], Frame, Score) -&gt;
    NewScore = Score + Roll1 + Roll2,
    score(Rest, Frame + 1, NewScore).
</pre></div>
<!-- end code -->


</div>
<div class='slide '>
<h1>Bowling Game</h1><!-- begin code{:lang=>"erlang", :line_numbers=>"false"} -->
<div class='code'><pre class='brush: erlang toolbar: false gutter: false'>
 %% Beginning
score(Rolls) -&gt;
    score(Rolls, 1, 0).

 %% End
score(_Rolls, 11, Score) -&gt; Score;

 %% Strike
score([10 | Rest], Frame, Score) -&gt;
    ...

 %% Spare
score([Roll1, Roll2 | Rest], Frame, Score) when Roll1 + Roll2 == 10 -&gt;
    ...

 %% Normal
score([Roll1, Roll2 | Rest], Frame, Score) -&gt;
    NewScore = Score + Roll1 + Roll2,
    score(Rest, Frame + 1, NewScore).
</pre></div>
<!-- end code -->


</div>
<div class='slide '>
<h1>Bowling Game</h1><!-- begin code{:lang=>"erlang", :line_numbers=>"false"} -->
<div class='code'><pre class='brush: erlang toolbar: false gutter: false'>
 %% Beginning
score(Rolls) -&gt;
    score(Rolls, 1, 0).

 %% End
score(_Rolls, 11, Score) -&gt; Score;

 %% Strike
score([10 | Rest], Frame, Score) -&gt;
    [Bonus1, Bonus2 | _] = Rest,
    NewScore = Score + 10 + Bonus1 + Bonus2,
    score(Rest, Frame + 1, NewScore);

 %% Spare
score([Roll1, Roll2 | Rest], Frame, Score) when Roll1 + Roll2 == 10 -&gt;
    [Bonus1 | _] = Rest,
    NewScore = Score + 10 + Bonus1,
    score(Rest, Frame + 1, NewScore);

 %% Normal
score([Roll1, Roll2 | Rest], Frame, Score) -&gt;
    NewScore = Score + Roll1 + Roll2,
    score(Rest, Frame + 1, NewScore).
</pre></div>
<!-- end code -->


</div>
<div class='slide '>
<h1>Bowling Game</h1><p>What about incomplete games?</p>

</div>
<div class='slide '>
<h1>Bowling Game</h1><p>What about incomplete games?</p>
<p>Several revisions later&#8230;</p>

</div>
<div class='slide '>
<h1>Bowling Game</h1><!-- begin code{:lang=>"erlang", :line_numbers=>"false"} -->
<div class='code'><pre class='brush: erlang toolbar: false gutter: false'>
score(Rolls) -&gt; score(Rolls, 1, 0).

score(_Rolls, 11, Score) -&gt; Score;

score([10 | Rest], Frame, Score) -&gt;
    score(Rest, Frame + 1, Score + 10 + strike_bonus(Rest));

score([Roll1, Roll2 | Rest], Frame, Score) when (Roll1 + Roll2 == 10) -&gt;
    score(Rest, Frame + 1, Score + 10 + spare_bonus(Rest));

score([Roll1, Roll2 | Rest], Frame, Score) -&gt;
    score(Rest, Frame + 1, Score + Roll1 + Roll2);

score([Roll1], _Frame, Score) -&gt; Score + Roll1;
score([], _Frame, Score) -&gt; Score.


spare_bonus([]) -&gt; 0;
spare_bonus([Bonus1 | _Rest]) -&gt; Bonus1.

strike_bonus([]) -&gt; 0;
strike_bonus([Only]) -&gt; Only;
strike_bonus([Bonus1, Bonus2 | _Rest]) -&gt; Bonus1 + Bonus2.
</pre></div>
<!-- end code -->


</div>
<div class='slide '>
<h1>Ok, that&#8217;s an algorithm</h1><p>To make it useful, we need to add</p>
<ul>
	<li>interface</li>
	<li>storage (mutable!)</li>
</ul>

</div>
<div class='slide '>
<h1>Sketching the CLI</h1><!-- begin code{:lang=>"erlang", :line_numbers=>"false"} -->
<div class='code'><pre class='brush: erlang toolbar: false gutter: false'>
Eshell V5.8.4  (abort with ^G)
1&gt; Line = io:get_line(&quot;Next&gt; &quot;).
Next&gt; 
</pre></div>
<!-- end code -->


</div>
<div class='slide '>
<h1>Sketching the CLI</h1><!-- begin code{:lang=>"erlang", :line_numbers=>"false"} -->
<div class='code'><pre class='brush: erlang toolbar: false gutter: false'>
Eshell V5.8.4  (abort with ^G)
1&gt; Line = io:get_line(&quot;Next&gt; &quot;).
Next&gt; colin 4
&quot;colin 4\n&quot;
</pre></div>
<!-- end code -->


</div>
<div class='slide '>
<h1>Sketching the CLI</h1><!-- begin code{:lang=>"erlang", :line_numbers=>"false"} -->
<div class='code'><pre class='brush: erlang toolbar: false gutter: false'>
Eshell V5.8.4  (abort with ^G)
1&gt; Line = io:get_line(&quot;Next&gt; &quot;).
Next&gt; colin 4
&quot;colin 4\n&quot;
2&gt; [Player, RollText] = string:tokens(Line, &quot; \t\n&quot;).
[&quot;colin&quot;,&quot;4&quot;]
</pre></div>
<!-- end code -->


</div>
<div class='slide '>
<h1>Sketching the CLI</h1><!-- begin code{:lang=>"erlang", :line_numbers=>"false"} -->
<div class='code'><pre class='brush: erlang toolbar: false gutter: false'>
Eshell V5.8.4  (abort with ^G)
1&gt; Line = io:get_line(&quot;Next&gt; &quot;).
Next&gt; colin 4
&quot;colin 4\n&quot;
2&gt; [Player, RollText] = string:tokens(Line, &quot; \t\n&quot;).
[&quot;colin&quot;,&quot;4&quot;]
3&gt; {Roll, _} = string:to_integer(RollText).
{4,[]}
</pre></div>
<!-- end code -->


</div>
<div class='slide '>
<h1>Sketching the CLI</h1><!-- begin code{:lang=>"erlang", :line_numbers=>"false"} -->
<div class='code'><pre class='brush: erlang toolbar: false gutter: false'>
Eshell V5.8.4  (abort with ^G)
1&gt; Line = io:get_line(&quot;Next&gt; &quot;).
Next&gt; colin 4
&quot;colin 4\n&quot;
2&gt; [Player, RollText] = string:tokens(Line, &quot; \t\n&quot;).
[&quot;colin&quot;,&quot;4&quot;]
3&gt; {Roll, _} = string:to_integer(RollText).
{4,[]}
4&gt; GameData = dict:new().
{dict,0,...
</pre></div>
<!-- end code -->


</div>
<div class='slide '>
<h1>Sketching the CLI</h1><!-- begin code{:lang=>"erlang", :line_numbers=>"false"} -->
<div class='code'><pre class='brush: erlang toolbar: false gutter: false'>
Eshell V5.8.4  (abort with ^G)
1&gt; Line = io:get_line(&quot;Next&gt; &quot;).
Next&gt; colin 4
&quot;colin 4\n&quot;
2&gt; [Player, RollText] = string:tokens(Line, &quot; \t\n&quot;).
[&quot;colin&quot;,&quot;4&quot;]
3&gt; {Roll, _} = string:to_integer(RollText).
{4,[]}
4&gt; GameData = dict:new().
{dict,0,...
5&gt; NewGameData = dict:append(Player, Roll, GameData).
{dict,1,...
</pre></div>
<!-- end code -->


</div>
<div class='slide '>
<h1>Sketching the CLI</h1><!-- begin code{:lang=>"erlang", :line_numbers=>"false"} -->
<div class='code'><pre class='brush: erlang toolbar: false gutter: false'>
Eshell V5.8.4  (abort with ^G)
1&gt; Line = io:get_line(&quot;Next&gt; &quot;).
Next&gt; colin 4
&quot;colin 4\n&quot;
2&gt; [Player, RollText] = string:tokens(Line, &quot; \t\n&quot;).
[&quot;colin&quot;,&quot;4&quot;]
3&gt; {Roll, _} = string:to_integer(RollText).
{4,[]}
4&gt; GameData = dict:new().
{dict,0,...
5&gt; NewGameData = dict:append(Player, Roll, GameData).
{dict,1,...
6&gt; {ok, Rolls} = dict:find(Player, NewGameData).
{ok,[4]}
</pre></div>
<!-- end code -->


</div>
<div class='slide '>
<h1>Sketching the CLI</h1><!-- begin code{:lang=>"erlang", :line_numbers=>"false"} -->
<div class='code'><pre class='brush: erlang toolbar: false gutter: false'>
Eshell V5.8.4  (abort with ^G)
1&gt; Line = io:get_line(&quot;Next&gt; &quot;).
Next&gt; colin 4
&quot;colin 4\n&quot;
2&gt; [Player, RollText] = string:tokens(Line, &quot; \t\n&quot;).
[&quot;colin&quot;,&quot;4&quot;]
3&gt; {Roll, _} = string:to_integer(RollText).
{4,[]}
4&gt; GameData = dict:new().
{dict,0,...
5&gt; NewGameData = dict:append(Player, Roll, GameData).
{dict,1,...
6&gt; {ok, Rolls} = dict:find(Player, NewGameData).
{ok,[4]}
7&gt; Score = bowling_game:score(Rolls).
4
</pre></div>
<!-- end code -->


</div>
<div class='slide '>
<h1>Sketching the CLI</h1><!-- begin code{:lang=>"erlang", :line_numbers=>"false"} -->
<div class='code'><pre class='brush: erlang toolbar: false gutter: false'>
Eshell V5.8.4  (abort with ^G)
1&gt; Line = io:get_line(&quot;Next&gt; &quot;).
Next&gt; colin 4
&quot;colin 4\n&quot;
2&gt; [Player, RollText] = string:tokens(Line, &quot; \t\n&quot;).
[&quot;colin&quot;,&quot;4&quot;]
3&gt; {Roll, _} = string:to_integer(RollText).
{4,[]}
4&gt; GameData = dict:new().
{dict,0,...
5&gt; NewGameData = dict:append(Player, Roll, GameData).
{dict,1,...
6&gt; {ok, Rolls} = dict:find(Player, NewGameData).
{ok,[4]}
7&gt; Score = bowling_game:score(Rolls).
4
</pre></div>
<!-- end code -->

<p>Normally, you&#8217;d start iterating at this point&#8230;</p>

</div>
<div class='slide '>
<h1>Recurse!</h1><!-- begin code{:lang=>"erlang", :line_numbers=>"false"} -->
<div class='code'><pre class='brush: erlang toolbar: false gutter: false'>
loop(GameData) -&gt;
    Line = io:get_line(&quot;Next&gt; &quot;),
    [Player, RollText] = string:tokens(Line, &quot; \t\n&quot;),
    {Roll, _} = string:to_integer(RollText),
    NewGameData = dict:append(Player, Roll, GameData),
    {ok, Rolls} = dict:find(Player, NewGameData).
    Score = bowling_game:score(Rolls).
    io:format(&quot;New score for ~s: ~p~n&quot;, [Player, Score]),
    loop(NewGameData).
</pre></div>
<!-- end code -->


</div>
<div class='slide '>
<h1>Escript kicks it off</h1><!-- begin code{:lang=>"erlang", :line_numbers=>"false"} -->
<div class='code'><pre class='brush: erlang toolbar: false gutter: false'>
#!/usr/local/bin/escript

-import(bowling_game).

main([]) -&gt;
    loop(dict:new()).

loop(GameData) -&gt;
    ...
</pre></div>
<!-- end code -->


</div>
<div class='slide '>
<h1>Webify!</h1><ul>
	<li>Simple web app</li>
	<li>Single page sends Ajax REST requests, updates itself</li>
	<li>Uses the Spooky web framework &amp; jQuery</li>
	<li>Spin off a process to manage the data (bowling_store)</li>
</ul>

</div>
<div class='slide '>
<h1>REST API</h1><pre>http://localhost:8000/add/Player/Roll</pre>
<p>e.g.</p>
<pre>http://localhost:8000/add/colin/4</pre>
<p><small>Yes, I&#8217;m modifying state with a GET. Shhh&#8230;</small></p>

</div>
<div class='slide '>
<h1>Spooky App</h1><!-- begin code{:lang=>"erlang", :line_numbers=>"false"} -->
<div class='code'><pre class='brush: erlang toolbar: false gutter: false'>
-module(bowling_web).
-behaviour(spooky).
-export([init/1, get/2]).  % Spooky API
-import(bowling_store).
</pre></div>
<!-- end code -->


</div>
<div class='slide '>
<h1>Spooky App</h1><!-- begin code{:lang=>"erlang", :line_numbers=>"false"} -->
<div class='code'><pre class='brush: erlang toolbar: false gutter: false'>
-module(bowling_web).
-behaviour(spooky).
-export([init/1, get/2]).  % Spooky API
-import(bowling_store).

init([])-&gt;
    register(store, bowling_store:init()),
    [{port, 8000}].
</pre></div>
<!-- end code -->


</div>
<div class='slide '>
<h1>Spooky App</h1><!-- begin code{:lang=>"erlang", :line_numbers=>"false"} -->
<div class='code'><pre class='brush: erlang toolbar: false gutter: false'>
-module(bowling_web).
-behaviour(spooky).
-export([init/1, get/2]).  % Spooky API
-import(bowling_store).

init([])-&gt;
    register(store, bowling_store:init()),
    [{port, 8000}].

get(_Req, [&quot;add&quot;, Player, RollText])-&gt;
    ...
</pre></div>
<!-- end code -->


</div>
<div class='slide '>
<h1>Spooky App</h1><!-- begin code{:lang=>"erlang", :line_numbers=>"false"} -->
<div class='code'><pre class='brush: erlang toolbar: false gutter: false'>
-module(bowling_web).
-behaviour(spooky).
-export([init/1, get/2]).  % Spooky API
-import(bowling_store).

init([])-&gt;
    register(store, bowling_store:init()),
    [{port, 8000}].

get(_Req, [&quot;add&quot;, Player, RollText])-&gt;
    Score = bowling_store:append(Player, RollText, store),
    {200, io_lib:format(&quot;~p&quot;, [Score])};
</pre></div>
<!-- end code -->


</div>
<div class='slide '>
<h1>Spooky App</h1><!-- begin code{:lang=>"erlang", :line_numbers=>"false"} -->
<div class='code'><pre class='brush: erlang toolbar: false gutter: false'>
-module(bowling_web).
-behaviour(spooky).
-export([init/1, get/2]).  % Spooky API
-import(bowling_store).

init([])-&gt;
    register(store, bowling_store:init()),
    [{port, 8000}].

get(_Req, [&quot;add&quot;, Player, RollText])-&gt;
    Score = bowling_store:append(Player, RollText, store),
    {200, io_lib:format(&quot;~p&quot;, [Score])};

get(Req, [])-&gt; get(Req, [&quot;form.html&quot;]);  % main page

get(_Req, Path)-&gt;  % other static resources
    Filename = filename:join(Path),
    case file:read_file(Filename) of
        {ok, PageBytes} -&gt; {200, binary_to_list(PageBytes)};
        {error, Reason} -&gt; {404, Reason}
    end.
</pre></div>
<!-- end code -->


</div>
<div class='slide '>
<h1>Bowling Store</h1><p>Remember the command-line loop?</p>
<!-- begin code{:lang=>"erlang", :line_numbers=>"false"} -->
<div class='code'><pre class='brush: erlang toolbar: false gutter: false'>
loop(GameData) -&gt;
    Line = io:get_line(&quot;Next&gt; &quot;),
    [Player, RollText] = string:tokens(Line, &quot; \t\n&quot;),

    {Roll, _} = string:to_integer(RollText),
    NewGameData = dict:append(Player, Roll, GameData),
    {ok, Rolls} = dict:find(Player, NewGameData).
    Score = bowling_game:score(Rolls).

    io:format(&quot;New score for ~s: ~p~n&quot;, [Player, Score]),
    loop(NewGameData).
</pre></div>
<!-- end code -->


</div>
<div class='slide '>
<h1>Bowling Store</h1><p>Here&#8217;s the request-handling loop.</p>
<!-- begin code{:lang=>"erlang", :line_numbers=>"false"} -->
<div class='code'><pre class='brush: erlang toolbar: false gutter: false'>
loop(GameData) -&gt;
    receive {From, {append, Player, RollText}} -&gt;

        {Roll, _} = string:to_integer(RollText),
        NewGameData = dict:append(Player, Roll, GameData),
        {ok, Rolls} = dict:find(Player, NewGameData),
        Score = bowling_game:score(Rolls),

        From ! Score,
        loop(NewGameData)
    end.
</pre></div>
<!-- end code -->


</div>
<div class='slide '>
<h1>Bowling Store</h1><!-- begin code{:lang=>"erlang", :line_numbers=>"false"} -->
<div class='code'><pre class='brush: erlang toolbar: false gutter: false'>
loop(GameData) -&gt;
    receive {From, {append, Player, RollText}} -&gt;
        {Roll, _} = string:to_integer(RollText),
        NewGameData = dict:append(Player, Roll, GameData),
        {ok, Rolls} = dict:find(Player, NewGameData),
        Score = bowling_game:score(Rolls),
        From ! Score,
        loop(NewGameData)
    end.

init() -&gt;
    Data = dict:new(),
    Start = fun() -&gt; loop(Data) end,
    spawn(Start).
</pre></div>
<!-- end code -->


</div>
<div class='slide '>
<h1>Bowling Store</h1><!-- begin code{:lang=>"erlang", :line_numbers=>"false"} -->
<div class='code'><pre class='brush: erlang toolbar: false gutter: false'>
loop(GameData) -&gt;
    receive {From, {append, Player, RollText}} -&gt;
        {Roll, _} = string:to_integer(RollText),
        NewGameData = dict:append(Player, Roll, GameData),
        {ok, Rolls} = dict:find(Player, NewGameData),
        Score = bowling_game:score(Rolls),
        From ! Score,
        loop(NewGameData)
    end.

init() -&gt;
    Data = dict:new(),
    Start = fun() -&gt; loop(Data) end,
    spawn(Start).

append(Player, RollText, Pid) -&gt;
    Pid ! {self(), {append, Player, RollText}},
    receive Resp -&gt; Resp end.
</pre></div>
<!-- end code -->


</div>
<div class='slide '>
<h1>Run it!</h1><!-- begin code{:lang=>"erlang", :line_numbers=>"false"} -->
<div class='code'><pre class='brush: erlang toolbar: false gutter: false'>
$ erl -pa $SPOOKY/ebin -pa $SPOOKY/deps/*/ebin
...
Eshell V5.8.4  (abort with ^G)
1&gt; spooky:start_link(bowling_web).
{ok,&lt;0.35.0&gt;}
2&gt; 
</pre></div>
<!-- end code -->


</div>
<div class='slide '>
<h1>Run it!</h1><!-- begin code{:lang=>"erlang", :line_numbers=>"false"} -->
<div class='code'><pre class='brush: erlang toolbar: false gutter: false'>
$ erl -pa $SPOOKY/ebin -pa $SPOOKY/deps/*/ebin
...
Eshell V5.8.4  (abort with ^G)
1&gt; spooky:start_link(bowling_web).
{ok,&lt;0.35.0&gt;}
2&gt; 
</pre></div>
<!-- end code -->

<p>Of course, I got tired of typing all that.</p>

</div>
<div class='slide '>
<h1>&#8230;with Escript!</h1><!-- begin code{:lang=>"erlang", :line_numbers=>"false"} -->
<div class='code'><pre class='brush: erlang toolbar: false gutter: false'>
#!/usr/local/bin/escript

main([]) -&gt;
    SpookyDir = os:getenv(&quot;SPOOKY_DIR&quot;),
    %% Add spooky and its dependencies to the code path.
    true = code:add_path(SpookyDir ++ &quot;/ebin&quot;),
    Deps = filelib:wildcard(SpookyDir ++ &quot;/deps/*/ebin&quot;),
    ok = code:add_paths(Deps),

    %% Compile our modules, just to be safe.
    c:c(bowling_game),
    c:c(bowling_store),
    c:c(bowling_web),

    spooky:start_link(bowling_web),
    io:format(&quot;Started spooky~n&quot;),

    io:get_line(&quot;Return to exit...  &quot;),
    spooky:stop().
</pre></div>
<!-- end code -->


</div>
<div class='slide '>
<h1>REST interaction</h1><p><img src="slide_images/bowling_rest_1.png" title="add/colin/3" alt="add/colin/3" /></p>

</div>
<div class='slide '>
<h1>REST interaction</h1><p><img src="slide_images/bowling_rest_2.png" title="add/colin/4" alt="add/colin/4" /></p>

</div>
<div class='slide '>
<h1>REST interaction</h1><p><img src="slide_images/bowling_rest_3.png" title="add/colin/10" alt="add/colin/10" /></p>

</div>
<div class='slide '>
<h1>REST interaction</h1><p><img src="slide_images/bowling_rest_4.png" title="add/colin/3" alt="add/colin/3" /></p>

</div>
<div class='slide '>
<h1>Webapp interaction</h1><p><img src="slide_images/bowling_app_1.png" title="add/colin/3" alt="add/colin/3" /></p>

</div>
<div class='slide '>
<h1>Webapp interaction</h1><p><img src="slide_images/bowling_app_2.png" title="add/colin/3" alt="add/colin/3" /></p>

</div>
<div class='slide '>
<h1>Webapp interaction</h1><p><img src="slide_images/bowling_app_3.png" title="add/colin/3" alt="add/colin/3" /></p>

</div>
<div class='slide '>
<h1>Webapp interaction</h1><p><img src="slide_images/bowling_app_4.png" title="add/colin/3" alt="add/colin/3" /></p>

</div>
<div class='slide '>
<h1>Webapp interaction</h1><p><img src="slide_images/bowling_app_5.png" title="add/colin/3" alt="add/colin/3" /></p>

</div>
<div class='slide '>
<h1>Webapp interaction</h1><p><img src="slide_images/bowling_app_6.png" title="add/colin/3" alt="add/colin/3" /></p>

</div>
<div class='slide '>
<h1>Webapp interaction</h1><p><img src="slide_images/bowling_app_7.png" title="add/colin/3" alt="add/colin/3" /></p>

</div>
<div class='slide '>
<h1>Extra credit: Automate REST tests</h1><p>Hit a REST URL, check value returned</p>
<ol>
	<li>http://localhost:8000/add/colin/3 &#8594; 3</li>
	<li>http://localhost:8000/add/colin/4 &#8594; 7</li>
	<li>http://localhost:8000/add/colin/10 &#8594; 17</li>
	<li>http://localhost:8000/add/colin/3 &#8594; 23</li>
</ol>

</div>
<div class='slide '>
<h1>Define test data</h1><!-- begin code{:lang=>"erlang", :line_numbers=>"false"} -->
<div class='code'><pre class='brush: erlang toolbar: false gutter: false'>
 %% web_tests.data
 %% Tests defined as list of {Player, Roll, Score} tuples
[
{colin, 3,  3},
{colin, 4,  7},
{colin, 10, 17},
{colin, 3,  23}
].  % need the period at the end
</pre></div>
<!-- end code -->


</div>
<div class='slide '>
<h1>Load test data from file</h1><!-- begin code{:lang=>"erlang", :line_numbers=>"false"} -->
<div class='code'><pre class='brush: erlang toolbar: false gutter: false'>
load_tests() -&gt;
    {ok, Handle} = file:open(&quot;web_tests.data&quot;, [read]),
    {ok, Tests} = io:read(Handle, &quot;&quot;),
    file:close(Handle),
    Tests.
</pre></div>
<!-- end code -->


</div>
<div class='slide '>
<h1>Make REST call</h1><!-- begin code{:lang=>"erlang", :line_numbers=>"false"} -->
<div class='code'><pre class='brush: erlang toolbar: false gutter: false'>
get_score(Player, Roll) -&gt;
    Url = io_lib:format(&quot;http://localhost:8000/add/~p/~p&quot;, [Player, Roll]),
    {ok, {_Status, _Header, Content}} = httpc:request(Url),
    {Score, _} = string:to_integer(Content),
    Score.
</pre></div>
<!-- end code -->


</div>
<div class='slide '>
<h1>Recurse through tests</h1><!-- begin code{:lang=>"erlang", :line_numbers=>"false"} -->
<div class='code'><pre class='brush: erlang toolbar: false gutter: false'>
#!/usr/local/bin/escript

 %% beginning
main(_) -&gt;
    inets:start(),
    Tests = load_tests(),
    Passed = Failed = 0,
    test(Tests, Passed, Failed).
</pre></div>
<!-- end code -->


</div>
<div class='slide '>
<h1>Recurse through tests</h1><!-- begin code{:lang=>"erlang", :line_numbers=>"false"} -->
<div class='code'><pre class='brush: erlang toolbar: false gutter: false'>
#!/usr/local/bin/escript

 %% beginning
main(_) -&gt;
    inets:start(),
    Tests = load_tests(),
    Passed = Failed = 0,
    test(Tests, Passed, Failed).

 %% end
test([], Passed, 0) -&gt;
    io:format(&quot;Passed! (~p tests)~n&quot;, [Passed]);

test([], Passed, Failed) -&gt;
    io:format(&quot;Failed! Passed ~p, Failed ~p~n&quot;, [Passed, Failed]);
</pre></div>
<!-- end code -->


</div>
<div class='slide '>
<h1>Recurse through tests</h1><!-- begin code{:lang=>"erlang", :line_numbers=>"false"} -->
<div class='code'><pre class='brush: erlang toolbar: false gutter: false'>
#!/usr/local/bin/escript

 %% beginning
main(_) -&gt;
    inets:start(),
    Tests = load_tests(),
    Passed = Failed = 0,
    test(Tests, Passed, Failed).

 %% end
test([], Passed, 0) -&gt;
    io:format(&quot;Passed! (~p tests)~n&quot;, [Passed]);

test([], Passed, Failed) -&gt;
    io:format(&quot;Failed! Passed ~p, Failed ~p~n&quot;, [Passed, Failed]);

 %% middle
test([{Player, Roll, Expected} | Tests], Passed, Failed) -&gt;
    case get_score(Player, Roll) of
        Expected -&gt;
            io:format(&quot;.&quot;),
            test(Tests, Passed + 1, Failed);
        Actual -&gt;
            io:format(&quot;Failed: expected=~p, actual=~p~n&quot;, [Expected, Actual]),
            test(Tests, Passed, Failed + 1)
    end.
</pre></div>
<!-- end code -->


</div>
<div class='slide '>
<h1>Run it!</h1><!-- begin code{:lang=>"erlang", :line_numbers=>"false"} -->
<div class='code'><pre class='brush: erlang toolbar: false gutter: false'>
$ ./start_server.erl 
Started spooky
Return to exit...  
</pre></div>
<!-- end code -->


</div>
<div class='slide '>
<h1>Run it!</h1><!-- begin code{:lang=>"erlang", :line_numbers=>"false"} -->
<div class='code'><pre class='brush: erlang toolbar: false gutter: false'>
$ ./start_server.erl 
Started spooky
Return to exit...  
</pre></div>
<!-- end code -->

<!-- begin code{:lang=>"bash", :line_numbers=>"false"} -->
<div class='code'><pre class='brush: bash toolbar: false gutter: false'>
$ ./web_test.erl 
....Passed! (4 tests)
</pre></div>
<!-- end code -->


</div>
<div class='slide '>
<h1>Run it!</h1><!-- begin code{:lang=>"erlang", :line_numbers=>"false"} -->
<div class='code'><pre class='brush: erlang toolbar: false gutter: false'>
$ ./start_server.erl 
Started spooky
Return to exit...  
</pre></div>
<!-- end code -->

<!-- begin code{:lang=>"bash", :line_numbers=>"false"} -->
<div class='code'><pre class='brush: bash toolbar: false gutter: false'>
$ ./web_test.erl 
....Passed! (4 tests)
</pre></div>
<!-- end code -->

<p><em>Add some debugging to bowling_web.erl, and you&#8217;ll see&#8230;</em></p>
<!-- begin code{:lang=>"erlang", :line_numbers=>"false"} -->
<div class='code'><pre class='brush: erlang toolbar: false gutter: false'>
$ ./start_server.erl 
Started spooky
Return to exit...  Add 3 for colin
Return to exit...  Add 4 for colin
Return to exit...  Add 10 for colin
Return to exit...  Add 3 for colin
Return to exit...  
</pre></div>
<!-- end code -->


</div>
<div class='slide '>
<h1>Wrap-up</h1><ul>
	<li>Synergistic Weirdness</li>
	<li>Idioms for recursion &amp; message handling</li>
	<li>Escript for CLI</li>
	<li>Spooky Webapps</li>
	<li>Think small, have fun!</li>
</ul>

</div>
<div class='slide '>
<h1>Crafty Erlang</h1><ul>
	<li>https://bluegraybox.github.com/Crafty-Erlang &#8211; <em>presentation</em></li>
	<li>https://github.com/bluegraybox/Crafty-Erlang &#8211; <em>S9 slideshow &amp; actual code modules</em></li>
</ul>
<p>Colin MacDonald</p>
<ul>
	<li>colin@bluegraybox.com</li>
	<li>bluegraybox.com/blog</li>
	<li>github.com/bluegraybox</li>
</ul></div>


</div><!-- presentation -->
</body>
</html>
